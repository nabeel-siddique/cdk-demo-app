trigger:
  branches:
    include:
      - main

pool:
  name: aws-cdk-app
  demands:
    - agent.name -equals cdk-syndicate

variables:
  - group: vars 21-Sep
  - name: ROLE_ARN
    value: arn:aws:iam::$(AWS_ACCOUNT_ID):role/$(ROLE_NAME)

steps:

- script: |
   if ! [ -x "$(command -v jq)" ]; then
    printf "%sPlease install jq %s\\n" 
    exit 1
   elif ! [ -x "$(command -v cdk)" ]; then
    printf "%sPlease install cdk %s\\n" 
    exit 1
   fi
  displayName: Check if jq and cdk are installed

- script: |
    python3 -m venv env
    source env/bin/activate
    pip install -r requirements.txt
    ASSUMED_CREDENTIALS=$(aws sts assume-role --role-arn arn:aws:iam::$(AWS_ACCOUNT_ID):role/ado-cdk-app --role-session-name cdk-app-cdployment-ado --external-id $(EXTERNAL_ID))
    AWS_ACCESS_KEY_ID=$(echo "${ASSUMED_CREDENTIALS}" | jq -r .Credentials.AccessKeyId)
    AWS_SECRET_ACCESS_KEY=$(echo "${ASSUMED_CREDENTIALS}" | jq -r .Credentials.SecretAccessKey)
    AWS_SESSION_TOKEN=$(echo "${ASSUMED_CREDENTIALS}" | jq -r .Credentials.SessionToken)

    export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    export AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
    cdk bootstrap 317048034783/eu-west-2
    cdk deploy

  displayName: Assume role with external id and execute deployment
